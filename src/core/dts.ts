import { promises as fs } from 'fs'
import { MODULE_NAME } from './constants'
import type Context from './context'

export async function generateDeclaration(ctx: Context, filePath: string) {
  const body = Array.from(ctx._cache)
    .sort((a, b) => a[0].localeCompare(b[0]))
    .map(([name, path]) => `  const ${name}: typeof import('${path}')['default']`)
    .join('\n')

  const dtsCode = `// Generated by '${MODULE_NAME}'
// We suggest you to commit this file into source control
declare global {
${body}
}

export {}
`

  await fs.writeFile(filePath, dtsCode, 'utf-8')
}
